from components.favor import Favor
from components import favor
from components import util
from matplotlib import pyplot
import numpy as np
import cv2
import skimage.measure

vgg16_filters = [[[0.42947057, 0.373467, -0.06136011],
                  [0.27476987, 0.03868078, -0.36722335],
                  [-0.05746817, -0.26224968, -0.35009676]],
                 [[0.55037946, 0.44007453, -0.08138704],
                  [0.34573907, 0.04063221, -0.4535013],
                  [-0.05863491, -0.33066967, -0.4850302]],
                 [[0.4800154, 0.4085474, -0.06514555],
                  [0.31047726, 0.05020237, -0.40338343],
                  [-0.05087169, -0.2852275, -0.41851634]],
                 [[0.11727387, 0.16206263, 0.135694],
                  [0.14835016, 0.20229845, 0.16168842],
                  [0.12934428, 0.17157242, 0.13871045]],
                 [[0.02087744, 0.04734124, 0.04185439],
                  [0.03104937, 0.06581022, 0.0462575],
                  [0.03167877, 0.05471011, 0.04231958]],
                 [[-0.17269668, -0.17037505, -0.15435153],
                  [-0.18760149, -0.17757156, -0.17439997],
                  [-0.16600266, -0.16666673, -0.1570488]],
                 [[3.40129584e-02, 1.70863140e-03, -1.15694344e-01],
                  [1.61559835e-01, 1.56414255e-01, -8.99365395e-02],
                  [1.29030216e-02, 5.44555223e-05, -1.25339806e-01]],
                 [[0.09883115, 0.05138195, -0.1017633],
                  [0.24075055, 0.2203114, -0.06674384],
                  [0.07595883, 0.04867976, -0.11207631]],
                 [[0.03755771, -0.00496297, -0.13803807],
                  [0.16659534, 0.15118818, -0.10984964],
                  [0.01562795, -0.00796698, -0.14913309]],
                 [[0.35422093, 0.27866557, 0.30172354],
                  [0.09780094, -0.362367, -0.04607875],
                  [-0.00097071, -0.40317345, -0.1468185]],
                 [[0.43703237, 0.3227509, 0.3510137],
                  [0.09673885, -0.42466447, -0.08895405],
                  [-0.0481492, -0.515417, -0.23510846]],
                 [[0.4087754, 0.3144911, 0.34451026],
                  [0.09916737, -0.39442134, -0.06177092],
                  [-0.02741977, -0.46822482, -0.19285059]],
                 [[-0.0865837, 0.19084392, 0.16842183],
                  [-0.18646947, 0.17608799, 0.15426615],
                  [-0.23963833, -0.14159909, -0.10266907]],
                 [[-0.10985146, 0.23999788, 0.23852432],
                  [-0.23399651, 0.20586449, 0.21035554],
                  [-0.33689022, -0.17719544, -0.10954819]],
                 [[-0.0820337, 0.25096548, 0.23059797],
                  [-0.18142731, 0.24379836, 0.228274],
                  [-0.27790195, -0.11767372, -0.06813156]],
                 [[0.22968295, 0.23940392, 0.23243521],
                  [0.25140768, 0.2676666, 0.2372588],
                  [0.22514924, 0.25982696, 0.22045547]],
                 [[-0.19237703, -0.22363968, -0.1873732],
                  [-0.21034837, -0.23609307, -0.22165568],
                  [-0.19264044, -0.19742602, -0.19427177]],
                 [[-0.04828076, -0.08605088, -0.04345802],
                  [-0.07164131, -0.10327227, -0.08243635],
                  [-0.04586786, -0.05622768, -0.04606855]]]

favor1 = Favor()
favor.FAVOR_FILE = '../data/favor.npy'
favor1.load()
for f in favor1.vuk.items:
    print(f)

img = cv2.imread('../img/0ae9ff8870953f0753c530022fe0aa13adcb0e00.jpg', 0)
x = 4
y = 4
ix = 1
pyplot.subplot(x, y, ix)
pyplot.imshow(img, cmap='gray')
ix += 1
for _ in range(x * y - 1):
    pyplot.subplot(x, y, ix)
    kernel_str = favor1.vuk.items[ix - 1].key
    kernel = util.string_to_feature_matrix(kernel_str)
    kernel = kernel.astype(np.float64)
    # kernel = np.array(vgg16_filters[ix - 2])
    feature = cv2.filter2D(img, -1, kernel)
    feature = skimage.measure.block_reduce(feature, (2, 2), np.max)
    feature = skimage.measure.block_reduce(feature, (2, 2), np.max)
    pyplot.imshow(feature, cmap='gray')
    ix += 1

pyplot.show()
